// app_ui.js — UI polished: card sections, RACI pills (words), real checklist, smarter search, fit-to-selection

const HOTSPOTS = [
  {
    "id": "P0.01",
    "points": [
      [
        91,
        227
      ],
      [
        87,
        264
      ],
      [
        206,
        227
      ],
      [
        206,
        264
      ]
    ]
  },
  {
    "id": "P0.02",
    "points": [
      [
        248,
        215
      ],
      [
        248,
        272
      ],
      [
        425,
        219
      ],
      [
        425,
        272
      ]
    ]
  },
  {
    "id": "P0.03",
    "points": [
      [
        491,
        244
      ],
      [
        574,
        161
      ],
      [
        656,
        244
      ],
      [
        574,
        330
      ]
    ]
  },
  {
    "id": "P0.05",
    "points": [
      [
        714,
        198
      ],
      [
        714,
        293
      ],
      [
        912,
        198
      ],
      [
        912,
        293
      ]
    ]
  },
  {
    "id": "P1.01",
    "points": [
      [
        953,
        215
      ],
      [
        953,
        277
      ],
      [
        1127,
        219
      ],
      [
        1123,
        272
      ]
    ]
  },
  {
    "id": "P1.02",
    "points": [
      [
        1168,
        244
      ],
      [
        1168,
        318
      ],
      [
        1366,
        244
      ],
      [
        1366,
        314
      ]
    ]
  },
  {
    "id": "P1.03",
    "points": [
      [
        1412,
        305
      ],
      [
        1412,
        359
      ],
      [
        1589,
        301
      ],
      [
        1589,
        359
      ]
    ]
  },
  {
    "id": "P1.04",
    "points": [
      [
        1416,
        202
      ],
      [
        1412,
        260
      ],
      [
        1585,
        198
      ],
      [
        1585,
        256
      ]
    ]
  },
  {
    "id": "P1.05",
    "points": [
      [
        1630,
        252
      ],
      [
        1634,
        305
      ],
      [
        1754,
        252
      ],
      [
        1754,
        305
      ]
    ]
  },
  {
    "id": "P1.06",
    "points": [
      [
        1795,
        244
      ],
      [
        1903,
        136
      ],
      [
        2014,
        244
      ],
      [
        1903,
        359
      ]
    ]
  },
  {
    "id": "P1.08",
    "points": [
      [
        2072,
        219
      ],
      [
        2072,
        272
      ],
      [
        2258,
        219
      ],
      [
        2254,
        272
      ]
    ]
  },
  {
    "id": "P1.09",
    "points": [
      [
        2299,
        206
      ],
      [
        2299,
        285
      ],
      [
        2497,
        210
      ],
      [
        2493,
        285
      ]
    ]
  },
  {
    "id": "P2.01",
    "points": [
      [
        2538,
        206
      ],
      [
        2538,
        285
      ],
      [
        2736,
        210
      ],
      [
        2736,
        285
      ]
    ]
  },
  {
    "id": "P2.02",
    "points": [
      [
        2782,
        215
      ],
      [
        2782,
        277
      ],
      [
        2930,
        219
      ],
      [
        2930,
        272
      ]
    ]
  },
  {
    "id": "P2.03",
    "points": [
      [
        2996,
        260
      ],
      [
        3083,
        165
      ],
      [
        3174,
        260
      ],
      [
        3083,
        355
      ]
    ]
  },
  {
    "id": "P2.05",
    "points": [
      [
        3232,
        194
      ],
      [
        3343,
        78
      ],
      [
        3459,
        190
      ],
      [
        3343,
        305
      ]
    ]
  },
  {
    "id": "P2.06",
    "points": [
      [
        3512,
        173
      ],
      [
        3512,
        215
      ],
      [
        3644,
        173
      ],
      [
        3644,
        215
      ]
    ]
  },
  {
    "id": "P3.01",
    "points": [
      [
        3686,
        157
      ],
      [
        3690,
        231
      ],
      [
        3888,
        153
      ],
      [
        3888,
        227
      ]
    ]
  },
  {
    "id": "P3.02",
    "points": [
      [
        3929,
        165
      ],
      [
        3929,
        223
      ],
      [
        4127,
        165
      ],
      [
        4127,
        223
      ]
    ]
  },
  {
    "id": "P3.03",
    "points": [
      [
        4173,
        194
      ],
      [
        4284,
        78
      ],
      [
        4396,
        190
      ],
      [
        4280,
        305
      ]
    ]
  },
  {
    "id": "P3.04",
    "points": [
      [
        4453,
        202
      ],
      [
        4453,
        244
      ],
      [
        4573,
        202
      ],
      [
        4573,
        239
      ]
    ]
  },
  {
    "id": "P3.05",
    "points": [
      [
        4614,
        177
      ],
      [
        4614,
        210
      ],
      [
        4738,
        173
      ],
      [
        4738,
        215
      ]
    ]
  },
  {
    "id": "P3.06",
    "points": [
      [
        4784,
        165
      ],
      [
        4784,
        219
      ],
      [
        4949,
        165
      ],
      [
        4949,
        219
      ]
    ]
  },
  {
    "id": "P4.01",
    "points": [
      [
        4990,
        161
      ],
      [
        4994,
        223
      ],
      [
        5163,
        165
      ],
      [
        5163,
        223
      ]
    ]
  },
  {
    "id": "P4.02",
    "points": [
      [
        5209,
        173
      ],
      [
        5209,
        210
      ],
      [
        5357,
        173
      ],
      [
        5357,
        215
      ]
    ]
  },
  {
    "id": "P5.01",
    "points": [
      [
        5403,
        173
      ],
      [
        5403,
        215
      ],
      [
        5551,
        173
      ],
      [
        5555,
        210
      ]
    ]
  },
  {
    "id": "P5.02",
    "points": [
      [
        5609,
        421
      ],
      [
        5683,
        347
      ],
      [
        5753,
        421
      ],
      [
        5683,
        491
      ]
    ]
  },
  {
    "id": "P5.03",
    "points": [
      [
        5844,
        437
      ],
      [
        5848,
        475
      ],
      [
        5964,
        437
      ],
      [
        5968,
        475
      ]
    ]
  },
  {
    "id": "P5.04",
    "points": [
      [
        6063,
        347
      ],
      [
        6141,
        264
      ],
      [
        6220,
        343
      ],
      [
        6141,
        425
      ]
    ]
  },
  {
    "id": "P5.05",
    "points": [
      [
        6302,
        190
      ],
      [
        6307,
        227
      ],
      [
        6501,
        190
      ],
      [
        6501,
        227
      ]
    ]
  },
  {
    "id": "P5.06",
    "points": [
      [
        5832,
        355
      ],
      [
        5832,
        392
      ],
      [
        5980,
        355
      ],
      [
        5976,
        392
      ]
    ]
  },
  {
    "id": "P6.01",
    "points": [
      [
        6042,
        471
      ],
      [
        6038,
        524
      ],
      [
        6240,
        471
      ],
      [
        6240,
        524
      ]
    ]
  },
  {
    "id": "P6.02",
    "points": [
      [
        6315,
        483
      ],
      [
        6315,
        520
      ],
      [
        6488,
        483
      ],
      [
        6488,
        520
      ]
    ]
  },
  {
    "id": "P6.03",
    "points": [
      [
        6542,
        223
      ],
      [
        6595,
        165
      ],
      [
        6645,
        219
      ],
      [
        6595,
        272
      ]
    ]
  },
  {
    "id": "P6.04",
    "points": [
      [
        6707,
        198
      ],
      [
        6707,
        239
      ],
      [
        6843,
        198
      ],
      [
        6843,
        239
      ]
    ]
  },
  {
    "id": "P7.01",
    "points": [
      [
        6884,
        198
      ],
      [
        6888,
        235
      ],
      [
        7004,
        202
      ],
      [
        7004,
        239
      ]
    ]
  },
  {
    "id": "P7.02",
    "points": [
      [
        7045,
        198
      ],
      [
        7045,
        239
      ],
      [
        7186,
        198
      ],
      [
        7186,
        239
      ]
    ]
  },
  {
    "id": "P7.03",
    "points": [
      [
        7252,
        219
      ],
      [
        7334,
        136
      ],
      [
        7417,
        219
      ],
      [
        7330,
        305
      ]
    ]
  },
  {
    "id": "P7.04",
    "points": [
      [
        7475,
        198
      ],
      [
        7475,
        239
      ],
      [
        7619,
        202
      ],
      [
        7619,
        235
      ]
    ]
  },
  {
    "id": "P7.05",
    "points": [
      [
        7660,
        190
      ],
      [
        7660,
        248
      ],
      [
        7858,
        190
      ],
      [
        7858,
        248
      ]
    ]
  },
  {
    "id": "P7.06",
    "points": [
      [
        7904,
        190
      ],
      [
        7904,
        248
      ],
      [
        8098,
        190
      ],
      [
        8098,
        248
      ]
    ]
  }
];

const STEPS = {
  "P0.01": {
    "title": "P0.01",
    "matrix_stage": "Назначение ГИПов/ответственных по подсистемам",
    "assign": "",
    "inputs": "1. Запрос/проект зафиксирован;\n2. Понятен тип объекта",
    "outputs": "1. Назначен технический владелец проекта и ответственные по ключевыми подсистемам",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "R/A",
      "ГИП": "I",
      "Старший инженер проектировщик": "I",
      "Менеджер по работе с партнерами": "I",
      "Старший инженер": "I",
      "Старший менеджер по закупкам": "I",
      "Средний срок выполнения (часов)": "188.88"
    },
    "checklist": [
      "назначен ГИП",
      "определены ответственные по ключевым подсистемам (если требуется)",
      "зафиксированы зоны ответственности",
      "понятен маршрут эскалации",
      "информация доведена до участников проекта"
    ]
  },
  "P0.02": {
    "title": "P0.02",
    "matrix_stage": "Назначение ГИПов/ответственных по подсистемам",
    "assign": "",
    "inputs": "1. Запрос/проект зафиксирован;\n2. Понятен тип объекта",
    "outputs": "1. Назначен технический владелец проекта и ответственные по ключевыми подсистемам",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "R/A",
      "ГИП": "I",
      "Старший инженер проектировщик": "I",
      "Менеджер по работе с партнерами": "I",
      "Старший инженер": "I",
      "Старший менеджер по закупкам": "I",
      "Средний срок выполнения (часов)": "188.88"
    },
    "checklist": [
      "назначен ГИП",
      "определены ответственные по ключевым подсистемам (если требуется)",
      "зафиксированы зоны ответственности",
      "понятен маршрут эскалации",
      "информация доведена до участников проекта"
    ]
  },
  "P0.03": {
    "title": "P0.03",
    "matrix_stage": "Назначение ГИПов/ответственных по подсистемам",
    "assign": "",
    "inputs": "1. Запрос/проект зафиксирован;\n2. Понятен тип объекта",
    "outputs": "1. Назначен технический владелец проекта и ответственные по ключевыми подсистемам",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "R/A",
      "ГИП": "I",
      "Старший инженер проектировщик": "I",
      "Менеджер по работе с партнерами": "I",
      "Старший инженер": "I",
      "Старший менеджер по закупкам": "I",
      "Средний срок выполнения (часов)": "188.88"
    },
    "checklist": [
      "назначен ГИП",
      "определены ответственные по ключевым подсистемам (если требуется)",
      "зафиксированы зоны ответственности",
      "понятен маршрут эскалации",
      "информация доведена до участников проекта"
    ]
  },
  "P0.05": {
    "title": "P0.05",
    "matrix_stage": "Назначение ГИПов/ответственных по подсистемам",
    "assign": "",
    "inputs": "1. Запрос/проект зафиксирован;\n2. Понятен тип объекта",
    "outputs": "1. Назначен технический владелец проекта и ответственные по ключевыми подсистемам",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "R/A",
      "ГИП": "I",
      "Старший инженер проектировщик": "I",
      "Менеджер по работе с партнерами": "I",
      "Старший инженер": "I",
      "Старший менеджер по закупкам": "I",
      "Средний срок выполнения (часов)": "188.88"
    },
    "checklist": [
      "назначен ГИП",
      "определены ответственные по ключевым подсистемам (если требуется)",
      "зафиксированы зоны ответственности",
      "понятен маршрут эскалации",
      "информация доведена до участников проекта"
    ]
  },
  "P1.01": {
    "title": "P1.01",
    "matrix_stage": "Технический пресейл: анализ исходных данных, обследование, концепция для КП",
    "assign": "Тех дир → ГИП",
    "inputs": "1. Запрос принят;\n2. Назначен ГИП;\n3. Собраны минимальные вводные",
    "outputs": "1. Сформирована техническая концепция для КП",
    "notify": "1. Тех дир;\n2. Старший менеджер по закупке",
    "raci": {
      "Тех Дир": "A",
      "ГИП": "R",
      "Старший инженер проектировщик": "C",
      "Менеджер по работе с партнерами": "C",
      "Старший менеджер по закупкам": "C",
      "Средний срок выполнения (часов)": "162.67"
    },
    "checklist": [
      "проанализированы входные данные",
      "определён принципиальный состав системы",
      "зафиксированы допущения",
      "выявлены ключевые ограничения",
      "концепция оформлена в понятном виде"
    ]
  },
  "P1.02": {
    "title": "P1.02",
    "matrix_stage": "Оценка реализуемости и рисков на пресейле",
    "assign": "Тех дир → ГИП",
    "inputs": "1. Есть черновая концепция пресейл",
    "outputs": "1. Определены ключевые риски, ограничения и условия реализуемости проекта",
    "notify": "1. Тех дир;\n2. Старший инженер проектироващик",
    "raci": {
      "Тех Дир": "A",
      "ГИП": "R",
      "Старший инженер проектировщик": "C",
      "Старший инженер": "C",
      "Старший менеджер по закупкам": "C",
      "Средний срок выполнения (часов)": "110.87"
    },
    "checklist": [
      "выявлены технические риски",
      "выявлены риски по площадке/срокам",
      "выявлены риски по поставке/доступности",
      "риски задокументированы",
      "понятны условия, при которых проект возможен"
    ]
  },
  "P1.03": {
    "title": "P1.03",
    "matrix_stage": "Запрос КП и условий у партнеров и актуализация базы условий",
    "assign": "ГИП → старший менеджер по работе с парнтнерами",
    "inputs": "1. Есть потребность проекта",
    "outputs": "1. Получены актуальные коммерческие условия и КП от партнёров",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "C",
      "Менеджер по работе с партнерами": "R/A",
      "Старший менеджер по закупкам": "C",
      "Средний срок выполнения (часов)": "183.81"
    },
    "checklist": [
      "получены КП",
      "сроки и условия подтверждены",
      "условия сопоставимы",
      "информация актуализирована",
      "данные доступны команде"
    ]
  },
  "P1.04": {
    "title": "P1.04",
    "matrix_stage": "Планирование и ведение закупок",
    "assign": "ГИП → старший менеджер по закупкам",
    "inputs": "1. Есть спецификации и приоритеты проекта",
    "outputs": "1. Сформирован и запущен план закупок по проекту (сроки, объёмы, ответственные)",
    "notify": "1. ГИП;\n2. Старший инженер",
    "raci": {
      "Тех Дир": "I",
      "ГИП": "C",
      "Старший инженер проектировщик": "C",
      "Менеджер по работе с партнерами": "C",
      "Старший менеджер по закупкам": "R/A",
      "Средний срок выполнения (часов)": "150.29"
    },
    "checklist": [
      "закупочная спецификация принята",
      "определены сроки и приоритеты",
      "заказы запущены",
      "логистика спланирована",
      "риски поставки учтены"
    ]
  },
  "P1.05": {
    "title": "P1.05",
    "matrix_stage": "Подготовка предварительных схем/допущений и техчасти КП",
    "assign": "ГИП → Младший инженер проектировщик",
    "inputs": "1. Есть концепция;\n2. Собраны КП/условия;\n3. Риски осмыслены",
    "outputs": "1. Подготовлена техническая часть КП (схемы, допущения, структура решения)",
    "notify": "1. Тех дир",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Младший инженер проектировщик": "R",
      "Менеджер по работе с партнерами": "I",
      "Старший менеджер по закупкам": "I",
      "Средний срок выполнения (часов)": "115.21"
    },
    "checklist": [
      "подготовлены принципиальные схемы",
      "сформирована предварительная спецификация",
      "допущения и исключения описаны",
      "техчасть КП согласована с концепцией",
      "пакет готов для внутреннего решения"
    ]
  },
  "P1.06": {
    "title": "P1.06",
    "matrix_stage": "Утверждение архитектуры проекта",
    "assign": "",
    "inputs": "1. Запрос/проект принят в техконтур;\n2. Есть черновая концепция",
    "outputs": "1. Утвержден архитектурный подход проекта (состав систем, ключевые принципы, границы решений)",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "R/A",
      "ГИП": "C",
      "Старший инженер проектировщик": "C",
      "Менеджер по работе с партнерами": "I",
      "Старший менеджер по закупкам": "I",
      "Средний срок выполнения (часов)": "220.95"
    },
    "checklist": [
      "определён состав систем и подсистем",
      "зафиксированы ключевые архитектурные принципы",
      "определены критичные стыки между системами",
      "понятны границы допустимых решений",
      "архитектура подтверждена ТД (устно/письменно/в системе)"
    ]
  },
  "P1.08": {
    "title": "P1.08",
    "matrix_stage": "Фиксация контрольной версии технических решений \"Freeze\"",
    "assign": "Тех дир → ГИП",
    "inputs": "1. Архитектура утверждена;\n2. Техпакет пресейл собран и прошел базовый QA",
    "outputs": "1. Зафиксирована контрольная версия технических решений;\n2. Определены правила изменений",
    "notify": "1. Старший инженер проектировщик",
    "raci": {
      "Тех Дир": "R/A",
      "ГИП": "C",
      "Старший инженер проектировщик": "I",
      "Менеджер по работе с партнерами": "I",
      "Старший инженер": "I",
      "Старший менеджер по закупкам": "I",
      "Средний срок выполнения (часов)": "0"
    },
    "checklist": [
      "определена контрольная версия решений",
      "baseline зафиксирован в системе/документе",
      "правила внесения изменений обозначены",
      "команда уведомлена о freeze",
      "закупки и проектирование работают от одной версии"
    ]
  },
  "P1.09": {
    "title": "P1.09",
    "matrix_stage": "Формирование инженерной команды и распределение задач",
    "assign": "Тех дир → ГИП",
    "inputs": "1. Назначен ГИП;\n2. Понятен объем работ и график",
    "outputs": "1. Сформирована инженерная команда проекта;\n2. Зоны ответственности распределены",
    "notify": "1. Старший инженер;\n2. ГИП;\n3. Старший инженер проектировщик",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Старший инженер проектировщик": "C",
      "Старший инженер": "C",
      "Средний срок выполнения (часов)": "68.69"
    },
    "checklist": [
      "назначены ключевые роли",
      "распределены зоны ответственности",
      "задачи поставлены исполнителям",
      "команда понимает объём работ",
      "каналы коммуникации определены"
    ]
  },
  "P2.01": {
    "title": "P2.01",
    "matrix_stage": "Организация разработки проектной/рабочей документации",
    "assign": "ГИП → старший инженер проектировщик",
    "inputs": "1. Freeze baseline сделан;\n2. Понятен состав документации",
    "outputs": "1. Сформирован план разработки П/РД;\n2. Задачи распределены между проектировщиками",
    "notify": "1. Старший инженер проектировщик;\n2. ГИП",
    "raci": {
      "Тех Дир": "I",
      "ГИП": "R/A",
      "Старший инженер проектировщик": "C",
      "Средний срок выполнения (часов)": "2.05"
    },
    "checklist": [
      "определён состав П/РД",
      "назначены исполнители",
      "установлены сроки выпуска",
      "определён формат и структура документов",
      "задачи заведены и распределены"
    ]
  },
  "P2.02": {
    "title": "P2.02",
    "matrix_stage": "Разработка проектной/рабочей документации",
    "assign": "Старший инженер проектировщик →отдел проектирования",
    "inputs": "1. Есть задания на проектирования;\n2. Есть baseline/исходные",
    "outputs": "1. Разработан комплект проектной / рабочей документации по утверждённым решениям",
    "notify": "1. Старший инженер проектировщик",
    "raci": {
      "ГИП": "C",
      "Старший инженер проектировщик": "A",
      "Инженер проектировщик": "R",
      "Младший инженер проектировщик": "R",
      "Инженер": "I",
      "Старший инженер": "I",
      "Средний срок выполнения (часов)": "283.71"
    },
    "checklist": [
      "все разделы П/РД выпущены",
      "документация соответствует baseline",
      "схемы и спецификации согласованы между собой",
      "документация готова к проверке",
      "версия зафиксирована"
    ]
  },
  "P2.03": {
    "title": "P2.03",
    "matrix_stage": "Внутренний контроль качества П/РД",
    "assign": "Старший инженер проектировщик →отдел проектирования",
    "inputs": "1. Черновик П/РД готов",
    "outputs": "1. Подтверждено качество П/РД;\n2. Выявленные замечания устранены или зафиксированы",
    "notify": "1. ГИП",
    "raci": {
      "ГИП": "C",
      "Старший инженер проектировщик": "R/A",
      "Инженер проектировщик": "I",
      "Младший инженер проектировщик": "I",
      "Средний срок выполнения (часов)": "108.46"
    },
    "checklist": [
      "проверена логика проектных решений",
      "выявленные коллизии устранены",
      "замечания оформлены и закрыты",
      "П/РД признана пригодной для реализации",
      "статус QA зафиксирован"
    ]
  },
  "P2.05": {
    "title": "P2.05",
    "matrix_stage": "Архитектурный контроль документации и \"стыков\" со смежными разделами",
    "assign": "Тех дир → ГИП",
    "inputs": "1. П/РД прошло внутренний контроль;\n2. Есть спорные места/\"стыки\"",
    "outputs": "1. Подтверждено соответствие П/РД утверждённой архитектуре и смежным разделам",
    "notify": "1. Тех дир",
    "raci": {
      "Тех Дир": "A",
      "ГИП": "R",
      "Старший инженер проектировщик": "C",
      "Средний срок выполнения (часов)": "82.16"
    },
    "checklist": [
      "П/РД соответствует утверждённой архитектуре",
      "критичные стыки проверены",
      "изменения согласованы",
      "архитектурных конфликтов нет",
      "подтверждение получено от ТД"
    ]
  },
  "P2.06": {
    "title": "P2.06",
    "matrix_stage": "Архитектурный контроль документации и \"стыков\" со смежными разделами",
    "assign": "Тех дир → ГИП",
    "inputs": "1. П/РД прошло внутренний контроль;\n2. Есть спорные места/\"стыки\"",
    "outputs": "1. Подтверждено соответствие П/РД утверждённой архитектуре и смежным разделам",
    "notify": "1. Тех дир",
    "raci": {
      "Тех Дир": "A",
      "ГИП": "R",
      "Старший инженер проектировщик": "C",
      "Средний срок выполнения (часов)": "82.16"
    },
    "checklist": [
      "П/РД соответствует утверждённой архитектуре",
      "критичные стыки проверены",
      "изменения согласованы",
      "архитектурных конфликтов нет",
      "подтверждение получено от ТД"
    ]
  },
  "P3.01": {
    "title": "P3.01",
    "matrix_stage": "Формирование спецификации оборудования, материалов, кабелей под закупку",
    "assign": "ГИП → Отдел проектирования",
    "inputs": "1. П/РД готово или на достаточном уровне готовности;\n2. Есть правила baseline",
    "outputs": "1. Сформирована и согласована спецификация оборудования и материалов для закупки",
    "notify": "1. Старший менеджер по закупке;\n2. Менеджер по работе с партнерами",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "A",
      "Старший инженер проектировщик": "R",
      "Инженер проектировщик": "R",
      "Менеджер по работе с партнерами": "C",
      "Старший менеджер по закупкам": "C",
      "Средний срок выполнения (часов)": "182.64"
    },
    "checklist": [
      "спецификация сформирована из П/РД",
      "все позиции однозначно определены",
      "указаны количества и требования",
      "спецификация пригодна для закупки",
      "согласована с закупками"
    ]
  },
  "P3.02": {
    "title": "P3.02",
    "matrix_stage": "Подбор оборудования и проработка альтернатив в рамках архитектуры",
    "assign": "ГИП → Отдел проектирования                                                            ГИП → Менеджер по закупкам",
    "inputs": "1. Есть спецификации/состав системы",
    "outputs": "1. Определены основные позиции оборудования и допустимые альтернативы",
    "notify": "1. Старший менеджер по закупке",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "A",
      "Старший инженер проектировщик": "R",
      "Инженер проектировщик": "R",
      "Менеджер по работе с партнерами": "C",
      "Старший менеджер по закупкам": "R",
      "Средний срок выполнения (часов)": "60.55"
    },
    "checklist": [
      "выбраны основные модели",
      "определены допустимые аналоги",
      "альтернативы не нарушают архитектуру",
      "проверена доступность",
      "информация зафиксирована"
    ]
  },
  "P3.03": {
    "title": "P3.03",
    "matrix_stage": "Утверждение замен оборудования и изменений, влияющих на архитектуру и ТСО",
    "assign": "Тех дир → ГИП",
    "inputs": "1. Есть запрос на замену + обоснование",
    "outputs": "1. Замены оборудования и изменения официально утверждены либо отклонены",
    "notify": "1. Старший менеджер по закупке;\n2. Старший инженер проектировщик;\n3. Старший инженер",
    "raci": {
      "Тех Дир": "A",
      "ГИП": "R",
      "Старший инженер проектировщик": "C",
      "Менеджер по работе с партнерами": "C",
      "Средний срок выполнения (часов)": "116.1"
    },
    "checklist": [
      "изменение описано и обосновано",
      "влияние на архитектуру оценено",
      "влияние на TCO учтено",
      "принято решение ТД",
      "решение доведено до команды"
    ]
  },
  "P3.04": {
    "title": "P3.04",
    "matrix_stage": "Утверждение замен оборудования и изменений, влияющих на архитектуру и ТСО",
    "assign": "Тех дир → ГИП",
    "inputs": "1. Есть запрос на замену + обоснование",
    "outputs": "1. Замены оборудования и изменения официально утверждены либо отклонены",
    "notify": "1. Старший менеджер по закупке;\n2. Старший инженер проектировщик;\n3. Старший инженер",
    "raci": {
      "Тех Дир": "A",
      "ГИП": "R",
      "Старший инженер проектировщик": "C",
      "Менеджер по работе с партнерами": "C",
      "Средний срок выполнения (часов)": "116.1"
    },
    "checklist": [
      "изменение описано и обосновано",
      "влияние на архитектуру оценено",
      "влияние на TCO учтено",
      "принято решение ТД",
      "решение доведено до команды"
    ]
  },
  "P3.05": {
    "title": "P3.05",
    "matrix_stage": "Планирование и ведение закупок",
    "assign": "ГИП → старший менеджер по закупкам",
    "inputs": "1. Есть спецификации и приоритеты проекта",
    "outputs": "1. Сформирован и запущен план закупок по проекту (сроки, объёмы, ответственные)",
    "notify": "1. ГИП;\n2. Старший инженер",
    "raci": {
      "Тех Дир": "I",
      "ГИП": "C",
      "Старший инженер проектировщик": "C",
      "Менеджер по работе с партнерами": "C",
      "Старший менеджер по закупкам": "R/A",
      "Средний срок выполнения (часов)": "150.29"
    },
    "checklist": [
      "закупочная спецификация принята",
      "определены сроки и приоритеты",
      "заказы запущены",
      "логистика спланирована",
      "риски поставки учтены"
    ]
  },
  "P3.06": {
    "title": "P3.06",
    "matrix_stage": "Контроль поставки: сроки, комплектность, претензии и замены",
    "assign": "ГИП → Старший менеджер по закупкам",
    "inputs": "1. Заказы размещены;\n2. Есть ожидаемые даты",
    "outputs": "1. Оборудование поставлено в срок и комплектно либо оформлены замены/претензии",
    "notify": "1. Старший инженер;\n2. ГИП",
    "raci": {
      "Тех Дир": "I",
      "ГИП": "C",
      "Менеджер по работе с партнерами": "C",
      "Старший инженер": "C",
      "Старший менеджер по закупкам": "R/A",
      "Средний срок выполнения (часов)": "54.94"
    },
    "checklist": [
      "поставка соответствует заказу",
      "комплектность проверена",
      "брак/некомплект зафиксирован (если есть)",
      "замены/претензии оформлены",
      "график проекта обновлён"
    ]
  },
  "P4.01": {
    "title": "P4.01",
    "matrix_stage": "Подготовка площадки и организация монтажа на объекте",
    "assign": "ГИП → Старший инженер",
    "inputs": "1. П/РД выпущено;\n2. Оборудование на объекте/в поставке;\n3. Есть окно работ, доступ",
    "outputs": "1. Площадка подготовлена к монтажу, определён порядок и график работ",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "I",
      "ГИП": "C",
      "Старший инженер проектировщик": "C",
      "Старший инженер": "R/A",
      "Средний срок выполнения (часов)": "172.5"
    },
    "checklist": [
      "доступы получены",
      "окна работ согласованы",
      "техника безопасности обеспечена",
      "материалы и инструмент готовы",
      "команда готова к выходу"
    ]
  },
  "P4.02": {
    "title": "P4.02",
    "matrix_stage": "Исполнение работ",
    "assign": "Старший инженер → Инженер",
    "inputs": "1. Площадка подготовлена;\n2. Есть документация и материалы",
    "outputs": "1. Монтажные работы выполнены в соответствии с проектной документацией",
    "notify": "1. Старший инженер;\n2. ГИП",
    "raci": {
      "Тех Дир": "I",
      "ГИП": "C",
      "Старший инженер проектировщик": "C",
      "Инженер проектировщик": "C",
      "Инженер": "R",
      "Старший инженер": "A",
      "Младший инженер": "R",
      "Средний срок выполнения (часов)": "224.76"
    },
    "checklist": [
      "работы выполнены по П/РД",
      "отклонения зафиксированы",
      "коммуникации проложены",
      "оборудование установлено",
      "объект готов к ПНР"
    ]
  },
  "P5.01": {
    "title": "P5.01",
    "matrix_stage": "Организация и контроль ПНР и интеграции на объекте",
    "assign": "Старший инженер → Инженер",
    "inputs": "1. Монтаж завершен (минимально);\n2. Есть необходимые конфиги, ПО, доступы",
    "outputs": "1. Системы настроены и интегрированы, готовы к испытаниям",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "I",
      "ГИП": "C",
      "Инженер": "R",
      "Старший инженер": "R/A",
      "Средний срок выполнения (часов)": "682.7"
    },
    "checklist": [
      "выполнены настройки",
      "интеграции работают",
      "сценарии проверены",
      "система стабильна",
      "готовность к испытаниям подтверждена"
    ]
  },
  "P5.02": {
    "title": "P5.02",
    "matrix_stage": "Диагностика и устранение неисправностей на объекте",
    "assign": "ГИП → Старший инженер",
    "inputs": "1. Есть сбой, неработающая часть",
    "outputs": "1. Выявленные неисправности устранены либо оформлена эскалация",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "й",
      "ГИП": "C",
      "Старший инженер": "R/A",
      "Средний срок выполнения (часов)": "38.35"
    },
    "checklist": [
      "проблема описана",
      "предприняты меры устранения",
      "результат зафиксирован",
      "при необходимости оформлена эскалация",
      "команда проинформирована"
    ]
  },
  "P5.03": {
    "title": "P5.03",
    "matrix_stage": "Диагностика и устранение неисправностей на объекте",
    "assign": "ГИП → Старший инженер",
    "inputs": "1. Есть сбой, неработающая часть",
    "outputs": "1. Выявленные неисправности устранены либо оформлена эскалация",
    "notify": "1. ГИП",
    "raci": {
      "Тех Дир": "й",
      "ГИП": "C",
      "Старший инженер": "R/A",
      "Средний срок выполнения (часов)": "38.35"
    },
    "checklist": [
      "проблема описана",
      "предприняты меры устранения",
      "результат зафиксирован",
      "при необходимости оформлена эскалация",
      "команда проинформирована"
    ]
  },
  "P5.04": {
    "title": "P5.04",
    "matrix_stage": "Эскалация технических отклонений и управление изменениями в реализации",
    "assign": "Старший инженер → ГИП",
    "inputs": "1. Зафиксировано отклонение или невозможность сделать по проекту",
    "outputs": "1. Технические отклонения оформлены и реализованы в рамках согласованных изменений",
    "notify": "1. Тех дир;\n2. Старший менеджер по закупке;\n3. Старший инженер проектировщик",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Старший инженер проектировщик": "C",
      "Менеджер по работе с партнерами": "I",
      "Старший инженер": "C",
      "Старший менеджер по закупкам": "I",
      "Средний срок выполнения (часов)": "0"
    },
    "checklist": [
      "отклонение зафиксировано",
      "принято решение по изменению",
      "изменения согласованы",
      "изменения внедрены",
      "документация обновлена"
    ]
  },
  "P5.05": {
    "title": "P5.05",
    "matrix_stage": "Эскалация технических отклонений и управление изменениями в реализации",
    "assign": "Старший инженер → ГИП",
    "inputs": "1. Зафиксировано отклонение или невозможность сделать по проекту",
    "outputs": "1. Технические отклонения оформлены и реализованы в рамках согласованных изменений",
    "notify": "1. Тех дир;\n2. Старший менеджер по закупке;\n3. Старший инженер проектировщик",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Старший инженер проектировщик": "C",
      "Менеджер по работе с партнерами": "I",
      "Старший инженер": "C",
      "Старший менеджер по закупкам": "I",
      "Средний срок выполнения (часов)": "0"
    },
    "checklist": [
      "отклонение зафиксировано",
      "принято решение по изменению",
      "изменения согласованы",
      "изменения внедрены",
      "документация обновлена"
    ]
  },
  "P5.06": {
    "title": "P5.06",
    "matrix_stage": "Определение обязательных проверок, испытаний, приемочных процедур",
    "assign": "Тех дир → ГИП",
    "inputs": "1. Понятна архитектура системы;\n2. Определен набор подсистем",
    "outputs": "1. Утверждён перечень обязательных проверок и критериев приёмки системы",
    "notify": "1. Старший инженер;\n2. ГИП",
    "raci": {
      "Тех Дир": "R/A",
      "ГИП": "C",
      "Старший инженер": "C",
      "Средний срок выполнения (часов)": "0"
    },
    "checklist": [
      "определён список проверок",
      "заданы критерии “принято/не принято”",
      "проверки привязаны к системам",
      "критерии доведены до исполнителей",
      "зафиксированы в проекте"
    ]
  },
  "P6.01": {
    "title": "P6.01",
    "matrix_stage": "Определение обязательных проверок, испытаний, приемочных процедур",
    "assign": "Тех дир → ГИП",
    "inputs": "1. Понятна архитектура системы;\n2. Определен набор подсистем",
    "outputs": "1. Утверждён перечень обязательных проверок и критериев приёмки системы",
    "notify": "1. Старший инженер;\n2. ГИП",
    "raci": {
      "Тех Дир": "R/A",
      "ГИП": "C",
      "Старший инженер": "C",
      "Средний срок выполнения (часов)": "0"
    },
    "checklist": [
      "определён список проверок",
      "заданы критерии “принято/не принято”",
      "проверки привязаны к системам",
      "критерии доведены до исполнителей",
      "зафиксированы в проекте"
    ]
  },
  "P6.02": {
    "title": "P6.02",
    "matrix_stage": "Испытания и приемочные проверки и оформление результатов",
    "assign": "ГИП → Старший инженер",
    "inputs": "1. ПНР завершены;\n2. Есть критерии приемки",
    "outputs": "1. Испытания проведены;\n2. Результаты зафиксированы;\n3. Замечания оформлены",
    "notify": "1. Тех дир;\n2. Старший инженер проектироващик",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Старший инженер": "R",
      "Средний срок выполнения (часов)": "94.23"
    },
    "checklist": [
      "испытания выполнены по программе",
      "результаты зафиксированы",
      "замечания оформлены (если есть)",
      "решение о приёмке принято",
      "статус доведён до команды"
    ]
  },
  "P6.03": {
    "title": "P6.03",
    "matrix_stage": "Испытания и приемочные проверки и оформление результатов",
    "assign": "ГИП → Старший инженер",
    "inputs": "1. ПНР завершены;\n2. Есть критерии приемки",
    "outputs": "1. Испытания проведены;\n2. Результаты зафиксированы;\n3. Замечания оформлены",
    "notify": "1. Тех дир;\n2. Старший инженер проектироващик",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Старший инженер": "R",
      "Средний срок выполнения (часов)": "94.23"
    },
    "checklist": [
      "испытания выполнены по программе",
      "результаты зафиксированы",
      "замечания оформлены (если есть)",
      "решение о приёмке принято",
      "статус доведён до команды"
    ]
  },
  "P6.04": {
    "title": "P6.04",
    "matrix_stage": "Испытания и приемочные проверки и оформление результатов",
    "assign": "ГИП → Старший инженер",
    "inputs": "1. ПНР завершены;\n2. Есть критерии приемки",
    "outputs": "1. Испытания проведены;\n2. Результаты зафиксированы;\n3. Замечания оформлены",
    "notify": "1. Тех дир;\n2. Старший инженер проектироващик",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Старший инженер": "R",
      "Средний срок выполнения (часов)": "94.23"
    },
    "checklist": [
      "испытания выполнены по программе",
      "результаты зафиксированы",
      "замечания оформлены (если есть)",
      "решение о приёмке принято",
      "статус доведён до команды"
    ]
  },
  "P7.01": {
    "title": "P7.01",
    "matrix_stage": "Сбор исполнительной информации",
    "assign": "Старший инженер → Инженер/Младший инженер",
    "inputs": "1. Монтаж и ПНР выполнены",
    "outputs": "1. Собрана фактическая информация по выполненным работам (as-built данные)",
    "notify": "1. Старший инженер проектировщик",
    "raci": {
      "ГИП": "C",
      "Старший инженер проектировщик": "I",
      "Инженер проектировщик": "I",
      "Инженер": "R",
      "Старший инженер": "A",
      "Младший инженер": "R",
      "Средний срок выполнения (часов)": "64.68"
    },
    "checklist": [
      "фотофиксация выполнена",
      "фактические трассы зафиксированы",
      "размещение оборудования уточнено",
      "данные переданы проектировщикам",
      "комплектность проверена"
    ]
  },
  "P7.02": {
    "title": "P7.02",
    "matrix_stage": "Актуализация исполнительной документации",
    "assign": "Старший инженер проектировщик →отдел проектирования",
    "inputs": "1. Получен факт с объекта",
    "outputs": "1. Исполнительная документация приведена в соответствие с фактическим исполнением",
    "notify": "1. ГИП;\n2. Старший инженер",
    "raci": {
      "Тех Дир": "I",
      "ГИП": "C",
      "Инженер проектировщик": "R",
      "Младший инженер проектировщик": "R",
      "Старший инженер": "C",
      "Средний срок выполнения (часов)": "115.05"
    },
    "checklist": [
      "ИД обновлена по факту",
      "изменения отражены",
      "версии документов зафиксированы",
      "ИД прошла проверку",
      "ИД готова к передаче"
    ]
  },
  "P7.03": {
    "title": "P7.03",
    "matrix_stage": "Актуализация исполнительной документации",
    "assign": "Старший инженер проектировщик →отдел проектирования",
    "inputs": "1. Получен факт с объекта",
    "outputs": "1. Исполнительная документация приведена в соответствие с фактическим исполнением",
    "notify": "1. ГИП;\n2. Старший инженер",
    "raci": {
      "Тех Дир": "I",
      "ГИП": "C",
      "Инженер проектировщик": "R",
      "Младший инженер проектировщик": "R",
      "Старший инженер": "C",
      "Средний срок выполнения (часов)": "115.05"
    },
    "checklist": [
      "ИД обновлена по факту",
      "изменения отражены",
      "версии документов зафиксированы",
      "ИД прошла проверку",
      "ИД готова к передаче"
    ]
  },
  "P7.04": {
    "title": "P7.04",
    "matrix_stage": "Подготовка инструкции по запуску, эксплуатации и обслуживанию (пакет передачи)",
    "assign": "ГИП → Старший инженер",
    "inputs": "1. Система принята по испытаниям;\n2. ИД акутализирована",
    "outputs": "1. Сформирован и передан пакет инструкций по запуску и эксплуатации системы",
    "notify": "1. Старший инженер;\n2. Сервисный инженер мульт. Комплекса",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Старший инженер проектировщик": "C",
      "Старший инженер": "A",
      "Средний срок выполнения (часов)": "204.12"
    },
    "checklist": [
      "инструкция по запуску подготовлена",
      "инструкция по эксплуатации подготовлена",
      "инструкции проверены на объекте",
      "пакет передан ответственным"
    ]
  },
  "P7.05": {
    "title": "P7.05",
    "matrix_stage": "Подготовка инструкции по запуску, эксплуатации и обслуживанию (пакет передачи)",
    "assign": "ГИП → Старший инженер",
    "inputs": "1. Система принята по испытаниям;\n2. ИД акутализирована",
    "outputs": "1. Сформирован и передан пакет инструкций по запуску и эксплуатации системы",
    "notify": "1. Старший инженер;\n2. Сервисный инженер мульт. Комплекса",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Старший инженер проектировщик": "C",
      "Старший инженер": "A",
      "Средний срок выполнения (часов)": "204.12"
    },
    "checklist": [
      "инструкция по запуску подготовлена",
      "инструкция по эксплуатации подготовлена",
      "инструкции проверены на объекте",
      "пакет передан ответственным"
    ]
  },
  "P7.06": {
    "title": "P7.06",
    "matrix_stage": "Подготовка инструкции по запуску, эксплуатации и обслуживанию (пакет передачи)",
    "assign": "ГИП → Старший инженер",
    "inputs": "1. Система принята по испытаниям;\n2. ИД акутализирована",
    "outputs": "1. Сформирован и передан пакет инструкций по запуску и эксплуатации системы",
    "notify": "1. Старший инженер;\n2. Сервисный инженер мульт. Комплекса",
    "raci": {
      "Тех Дир": "C",
      "ГИП": "R/A",
      "Старший инженер проектировщик": "C",
      "Старший инженер": "A",
      "Средний срок выполнения (часов)": "204.12"
    },
    "checklist": [
      "инструкция по запуску подготовлена",
      "инструкция по эксплуатации подготовлена",
      "инструкции проверены на объекте",
      "пакет передан ответственным"
    ]
  }
};


function getPhase(id) {
  const m = String(id||"").match(/^([PS]\d+)/);
  return m ? m[1] : "UNK";
}

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
}

function linesToUl(text) {
  const t = String(text ?? "").trim();
  if (!t) return '<div class="muted">—</div>';
  const items = t.split(/\n+/).map(x=>x.trim()).filter(Boolean);
  return '<ul class="list">' + items.map(i=>'<li>'+escapeHtml(i)+'</li>').join('') + '</ul>';
}

function normalizePoints(points) {
  if (!Array.isArray(points) || points.length < 3) return [];
  let cx=0, cy=0;
  for (let i=0;i<points.length;i++) { cx += points[i][0]; cy += points[i][1]; }
  cx /= points.length; cy /= points.length;
  return points.slice().sort((a,b)=>
    Math.atan2(a[1]-cy,a[0]-cx) - Math.atan2(b[1]-cy,b[0]-cx)
  );
}

const PHASE_STYLE = {
  P0:  { fill: "rgba(255,230,0,0.18)" },
  P1:  { fill: "rgba(0,200,255,0.18)" },
  P2:  { fill: "rgba(120,255,0,0.18)" },
  P3:  { fill: "rgba(255,140,0,0.18)" },
  P4:  { fill: "rgba(190,120,255,0.18)" },
  P5:  { fill: "rgba(255,0,140,0.18)" },
  P6:  { fill: "rgba(0,255,170,0.18)" },
  P7:  { fill: "rgba(160,160,160,0.18)" },
  S1:  { fill: "rgba(255,80,80,0.20)" },
  UNK: { fill: "rgba(200,200,200,0.18)" }
};

const RACILABEL = {
  R: "Исполнитель",
  A: "Ответственный",
  C: "Консультирует",
  I: "Информируется"
};

function raciToWords(val) {
  const s = String(val||"").toUpperCase();
  const parts = s.split(/[^RACI]+/).filter(Boolean);
  if (!parts.length) return "";
  const uniq = [...new Set(parts)];
  return uniq.map(x => RACILABEL[x] || x).join(" / ");
}

function injectStyles() {
  if (document.getElementById("uiStyle")) return;
  const css = `
    .panelCard{border:1px solid #eee;border-radius:16px;padding:14px;box-shadow:0 4px 18px rgba(0,0,0,.06);}
    .hTitle{font-size:18px;font-weight:800;margin:0;}
    .hSub{color:#666;font-size:12px;margin-top:6px;display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid #eaeaea;border-radius:999px;font-size:12px;background:#fafafa}
    .muted{color:#999;font-size:13px}
    .section{margin-top:12px;border:1px solid #eee;border-radius:14px;overflow:hidden}
    .section summary{list-style:none;cursor:pointer;padding:10px 12px;font-weight:700;background:#fbfbfb;display:flex;justify-content:space-between;align-items:center}
    .section summary::-webkit-details-marker{display:none}
    .section .content{padding:10px 12px;background:#fff;border-top:1px solid #eee}
    .list{margin:6px 0 0 18px}
    .pillRow{display:flex;flex-wrap:wrap;gap:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #eee;border-radius:999px;background:#fff}
    .pill .k{font-weight:800}
    .pill .v{color:#444;font-size:13px}
    .checkItem{display:flex;gap:10px;align-items:flex-start;padding:6px 0}
    .checkItem input{margin-top:3px}
    .btnSmall{padding:6px 10px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
    .btnSmall:hover{background:#f3f3f3}
    .searchEmpty{color:#999;font-size:13px;margin-top:8px}
  `;
  const style = document.createElement("style");
  style.id = "uiStyle";
  style.textContent = css;
  document.head.appendChild(style);
}

let selectedId = null;
let polyById = new Map();

function initPanel(panel) {
  injectStyles();
  panel.innerHTML =
    '<div style="display:flex;gap:8px;align-items:center;">' +
      '<input id="stepSearch" placeholder="Поиск: P3.04 или слово..." ' +
        'style="flex:1;padding:8px 10px;border:1px solid #ddd;border-radius:10px;outline:none;">' +
      '<button id="clearSearch" class="btnSmall">×</button>' +
    '</div>' +
    '<div id="searchResults" style="margin-top:10px;"></div>' +
    '<hr style="margin:12px 0;border:none;border-top:1px solid #eee;">' +
    '<div id="stepDetails"><div class="panelCard"><h2 class="hTitle">Выбери блок</h2><div class="muted">Кликни по блоку слева — справа откроются детали.</div></div></div>';
}

function checklistKey(id){ return "check:" + id; }

function loadChecks(id){
  try { return JSON.parse(localStorage.getItem(checklistKey(id)) || "[]"); } catch { return []; }
}
function saveChecks(id, arr){
  try { localStorage.setItem(checklistKey(id), JSON.stringify(arr)); } catch {}
}

function renderStep(panel, id) {
  const s = STEPS[id] || {};
  const phase = getPhase(id);

  const raciEntries = s.raci ? Object.entries(s.raci) : [];
  const raciHtml = raciEntries.length
    ? '<div class="pillRow">' + raciEntries.map(([role,val]) => {
        const words = raciToWords(val);
        return '<div class="pill"><span class="k">'+escapeHtml(role)+'</span><span class="v">'+escapeHtml(words || val)+'</span></div>';
      }).join('') + '</div>'
    : '<div class="muted">Нет данных</div>';

  const checklist = Array.isArray(s.checklist) ? s.checklist : [];
  const saved = loadChecks(id);
  const checklistHtml = checklist.length ? (
      '<div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:6px;">' +
        '<button id="resetChecks" class="btnSmall">Сбросить</button>' +
      '</div>' +
      checklist.map((it, i) => {
        const checked = saved.includes(i) ? "checked" : "";
        return '<label class="checkItem"><input type="checkbox" data-ck="'+i+'" '+checked+'><span>'+escapeHtml(it)+'</span></label>';
      }).join('')
    ) : '<div class="muted">Нет чек-листа</div>';

  panel.querySelector("#stepDetails").innerHTML = `
    <div class="panelCard">
      <h1 class="hTitle">${escapeHtml(id)} — ${escapeHtml(s.title || "")}</h1>
      <div class="hSub">
        <span class="badge">Фаза: <b>${escapeHtml(phase)}</b></span>
        <span class="badge">Этап матрицы: <b>${escapeHtml(s.matrix_stage || "—")}</b></span>
      </div>

      <details class="section" open>
        <summary>Вход в этап <span>▾</span></summary>
        <div class="content">${linesToUl(s.inputs)}</div>
      </details>

      <details class="section" open>
        <summary>Выход из этапа <span>▾</span></summary>
        <div class="content">${linesToUl(s.outputs)}</div>
      </details>

      <details class="section">
        <summary>Кто кому может ставить задачу <span>▾</span></summary>
        <div class="content">${escapeHtml(s.assign || "—")}</div>
      </details>

      <details class="section" open>
        <summary>RACI <span>▾</span></summary>
        <div class="content">${raciHtml}</div>
      </details>

      <details class="section" open>
        <summary>Чек-лист <span>▾</span></summary>
        <div class="content">${checklistHtml}</div>
      </details>

      <details class="section">
        <summary>Уведомить при завершении <span>▾</span></summary>
        <div class="content">${escapeHtml(s.notify || "—")}</div>
      </details>
    </div>
  `;

  // hook checklist persistence
  const resetBtn = panel.querySelector("#resetChecks");
  if (resetBtn) {
    resetBtn.onclick = () => {
      saveChecks(id, []);
      renderStep(panel, id);
    };
  }
  panel.querySelectorAll('input[type="checkbox"][data-ck]').forEach(cb => {
    cb.addEventListener("change", () => {
      const idx = parseInt(cb.getAttribute("data-ck"), 10);
      const now = new Set(loadChecks(id));
      if (cb.checked) now.add(idx);
      else now.delete(idx);
      saveChecks(id, [...now].sort((a,b)=>a-b));
    });
  });
}

function searchSteps(q) {
  q = (q || '').trim().toLowerCase();
  if (!q) return [];
  const out = [];
  for (const id in STEPS) {
    const s = STEPS[id] || {};
    const hay = (id + ' ' + (s.title||'') + ' ' + (s.matrix_stage||'')).toLowerCase();
    let score = 0;
    if (id.toLowerCase() === q) score += 1000;
    if (id.toLowerCase().startsWith(q)) score += 600;
    if (hay.includes(q)) score += 120;
    if (score>0) out.push({id, title: s.title||id, matrix: s.matrix_stage||'', score});
  }
  out.sort((a,b)=>b.score-a.score);
  return out.slice(0, 10);
}

function renderSearch(panel, results, query) {
  const box = panel.querySelector("#searchResults");
  const q = (query || "").trim();
  if (!q) { box.innerHTML = ""; return; } // ✅ no "nothing found" when empty
  if (!results.length) {
    box.innerHTML = '<div class="searchEmpty">Ничего не найдено</div>';
    return;
  }
  box.innerHTML = results.map(r =>
    '<div data-id="'+escapeHtml(r.id)+'" style="padding:8px 10px;border:1px solid #eee;border-radius:10px;margin-bottom:6px;cursor:pointer;">' +
      '<div style="font-weight:800;">'+escapeHtml(r.id)+'</div>' +
      '<div style="color:#666;font-size:13px;">'+escapeHtml(r.title)+'</div>' +
      (r.matrix ? '<div style="color:#999;font-size:12px;margin-top:3px;">'+escapeHtml(r.matrix)+'</div>' : '') +
    '</div>'
  ).join('');
  box.querySelectorAll("[data-id]").forEach(el => el.addEventListener("click", () => pickStep(el.getAttribute("data-id"), {fit:true})));
}

function highlight(id) {
  polyById.forEach(p => {
    p.style.stroke = "rgba(0,0,0,0.25)";
    p.style.strokeWidth = "1";
  });
  const p = polyById.get(id);
  if (p) {
    p.style.stroke = "rgba(0,0,0,0.70)";
    p.style.strokeWidth = "2";
  }
}

function fitToSelection(id) {
  const p = polyById.get(id);
  const viewport = document.getElementById("viewport");
  const img = document.getElementById("diagram");
  const zoomRange = document.getElementById("zoomRange");

  if (!p || !viewport || !img) return;

  // bbox in current SVG coordinates (same as img display)
  const bbox = p.getBBox();
  const pad = 40;
  const targetW = viewport.clientWidth - pad;
  const targetH = viewport.clientHeight - pad;

  // if zoom control exists — adjust zoom to fit bbox
  if (zoomRange && img.naturalWidth) {
    const currentZoom = img.clientWidth / img.naturalWidth; // 0..?
    const needScale = Math.min(targetW / bbox.width, targetH / bbox.height);
    let newZoom = Math.round((currentZoom * needScale) * 100);
    newZoom = Math.max(60, Math.min(300, newZoom));

    zoomRange.value = String(newZoom);
    // trigger input so your existing zoom handler redraws svg
    zoomRange.dispatchEvent(new Event("input", {bubbles:true}));
  }

  // center scroll (works even without zoom)
  viewport.scrollLeft = Math.max(0, bbox.x + bbox.width/2 - viewport.clientWidth/2);
  viewport.scrollTop  = Math.max(0, bbox.y + bbox.height/2 - viewport.clientHeight/2);
}

function pickStep(id, opts) {
  selectedId = id;
  highlight(id);
  renderStep(document.getElementById("panel"), id);

  const shouldFit = opts && opts.fit;
  if (shouldFit) fitToSelection(id);
}

function ensureSvgOverlay(img, canvas) {
  let svg = document.getElementById("hotspotSvg");
  if (!svg) {
    svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("id", "hotspotSvg");
    svg.style.position = "absolute";
    svg.style.left = "0";
    svg.style.top = "0";
    svg.style.pointerEvents = "auto";
    canvas.appendChild(svg);
  }
  svg.setAttribute("width", img.clientWidth);
  svg.setAttribute("height", img.clientHeight);
  svg.setAttribute("viewBox", "0 0 " + img.clientWidth + " " + img.clientHeight);
  return svg;
}

function drawHotspotsSvg(svg, img) {
  while (svg.firstChild) svg.removeChild(svg.firstChild);
  polyById.clear();

  const sx = img.clientWidth / img.naturalWidth;
  const sy = img.clientHeight / img.naturalHeight;

  HOTSPOTS.forEach(h => {
    const id = h.id;
    if (!id || !Array.isArray(h.points)) return;
    const pts = normalizePoints(h.points);
    if (!pts.length) return;

    const spts = pts.map(p => [p[0]*sx, p[1]*sy]);
    const pointsAttr = spts.map(p => p[0].toFixed(2)+","+p[1].toFixed(2)).join(" ");

    const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
    poly.setAttribute("points", pointsAttr);
    poly.style.fill = (PHASE_STYLE[getPhase(id)] || PHASE_STYLE.UNK).fill;
    poly.style.stroke = "rgba(0,0,0,0.25)";
    poly.style.strokeWidth = "1";
    poly.style.cursor = "pointer";

    poly.addEventListener("click", () => pickStep(id, {fit:true}));

    poly.addEventListener("mouseenter", () => {
      if (selectedId === id) return;
      poly.style.stroke = "rgba(0,0,0,0.55)";
      poly.style.strokeWidth = "2";
    });
    poly.addEventListener("mouseleave", () => {
      if (selectedId === id) return;
      poly.style.stroke = "rgba(0,0,0,0.25)";
      poly.style.strokeWidth = "1";
    });

    svg.appendChild(poly);
    polyById.set(id, poly);
  });

  if (selectedId && polyById.has(selectedId)) highlight(selectedId);
}

window.onload = function() {
  try {
    const canvas = document.getElementById("canvas");
    const img = document.getElementById("diagram");
    const panel = document.getElementById("panel");
    initPanel(panel);

    const input = panel.querySelector("#stepSearch");
    const clearBtn = panel.querySelector("#clearSearch");

    function refresh() {
      const r = searchSteps(input.value);
      renderSearch(panel, r, input.value);
    }

    input.addEventListener("input", refresh);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const r = searchSteps(input.value);
        if (r.length) pickStep(r[0].id, {fit:true});
      }
    });

    clearBtn.addEventListener("click", () => {
      input.value = "";
      panel.querySelector("#searchResults").innerHTML = "";
      input.focus();
    });

    function redraw() {
      const svg = ensureSvgOverlay(img, canvas);
      drawHotspotsSvg(svg, img);
    }

    if (!img.complete) img.onload = redraw;
    else redraw();

    window.addEventListener("resize", redraw);
  } catch (e) {
    alert("Ошибка в app.js: " + e);
    console.error(e);
  }
};
